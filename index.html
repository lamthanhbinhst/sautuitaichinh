 <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6 T√∫i T√†i Ch√≠nh</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; margin: 0; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const JAR_CONFIG = [
            { id: 'NEC', name: 'Thi·∫øt y·∫øu', color: 'bg-blue-500', icon: 'üè†', description: 'ƒÇn u·ªëng, nh√† ·ªü' },
            { id: 'FFA', name: 'T·ª± do t√†i ch√≠nh', color: 'bg-green-500', icon: 'üìà', description: 'ƒê·∫ßu t∆∞' },
            { id: 'LTS', name: 'Ti·∫øt ki·ªám', color: 'bg-purple-500', icon: 'üí∞', description: 'M·ª•c ti√™u l·ªõn' },
            { id: 'EDU', name: 'Gi√°o d·ª•c', color: 'bg-orange-500', icon: 'üéì', description: 'Ph√°t tri·ªÉn b·∫£n th√¢n' },
            { id: 'PLAY', name: 'H∆∞·ªüng th·ª•', color: 'bg-red-500', icon: 'üèñÔ∏è', description: 'Gi·∫£i tr√≠' },
            { id: 'GIVE', name: 'Cho ƒëi', color: 'bg-pink-500', icon: '‚ù§Ô∏è', description: 'T·ª´ thi·ªán, gi√∫p ƒë·ª°' },
        ];

        const PieChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            useEffect(() => {
                if (chartInstance.current) chartInstance.current.destroy();
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(j => j.name),
                        datasets: [{
                            data: data.map(j => Math.max(0, j.amount)),
                            backgroundColor: ['#3b82f6', '#10b981', '#a855f7', '#f97316', '#ef4444', '#ec4899'],
                            borderWidth: 0
                        }]
                    },
                    options: { plugins: { legend: { display: false } }, cutout: '75%' }
                });
            }, [data]);
            return (
                <div className="relative w-44 h-44 mx-auto my-4">
                    <canvas ref={chartRef}></canvas>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className="text-[10px] text-gray-400 uppercase font-bold tracking-widest">S·ªë d∆∞</span>
                        <span className="text-lg font-black text-gray-800">T·ªï h·ª£p</span>
                    </div>
                </div>
            );
        };

        function App() {
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('financialData_v4');
                return saved ? JSON.parse(saved) : [{ 
                    month: new Date().toISOString().slice(0, 7), 
                    incomes: [], 
                    expenses: [],
                    ratios: { NEC: 55, FFA: 10, LTS: 10, EDU: 10, PLAY: 10, GIVE: 5 }
                }];
            });
            const [selectedMonth, setSelectedMonth] = useState(history[history.length - 1].month);
            const [isAddMonthOpen, setIsAddMonthOpen] = useState(false);
            const [isRatioEditOpen, setIsRatioEditOpen] = useState(false);
            const [tempRatios, setTempRatios] = useState({});

            useEffect(() => {
                localStorage.setItem('financialData_v4', JSON.stringify(history));
            }, [history]);

            const currentRecord = history.find(r => r.month === selectedMonth) || history[0];

            const balances = useMemo(() => {
                const res = {}; const cumul = {};
                [...history].sort((a, b) => a.month.localeCompare(b.month)).forEach(rec => {
                    const totalInc = rec.incomes.reduce((s, i) => s + i.amount, 0);
                    const ratios = rec.ratios || { NEC: 55, FFA: 10, LTS: 10, EDU: 10, PLAY: 10, GIVE: 5 };
                    res[rec.month] = JAR_CONFIG.map(j => {
                        const perc = ratios[j.id] || 0;
                        const added = (totalInc * perc) / 100;
                        const spent = rec.expenses.filter(e => e.jarId === j.id).reduce((s, e) => s + e.amount, 0);
                        cumul[j.id] = (cumul[j.id] || 0) + added - spent;
                        return { ...j, percentage: perc, amount: cumul[j.id], spentThisMonth: spent };
                    });
                });
                return res;
            }, [history]);

            const currentBalances = balances[selectedMonth] || [];

            const addTransaction = (type, jarId = null) => {
                const amount = prompt("Nh·∫≠p s·ªë ti·ªÅn (ƒë):");
                const desc = prompt("M√¥ t·∫£:");
                if (amount && desc) {
                    setHistory(old => old.map(r => r.month === selectedMonth ? {
                        ...r, [type === 'income' ? 'incomes' : 'expenses']: [...r[type === 'income' ? 'incomes' : 'expenses'], 
                        { id: Date.now().toString(), amount: parseInt(amount), description: desc, jarId }]
                    } : r));
                }
            };

            const saveRatios = () => {
                const total = Object.values(tempRatios).reduce((s, v) => s + (parseInt(v) || 0), 0);
                if (total !== 100) {
                    alert(`T·ªïng l√† ${total}%. Vui l√≤ng ƒëi·ªÅu ch·ªânh l·∫°i cho ƒë√∫ng 100%!`);
                    return;
                }
                setHistory(old => old.map(r => r.month === selectedMonth ? { ...r, ratios: tempRatios } : r));
                setIsRatioEditOpen(false);
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 pb-24">
                    <header className="p-4 bg-white shadow-sm flex justify-between items-center sticky top-0 z-40">
                        <h1 className="font-black text-xl text-gray-800 tracking-tighter">6 T√öI</h1>
                        <div className="flex gap-2">
                             <button onClick={() => { setTempRatios(currentRecord.ratios); setIsRatioEditOpen(true); }} className="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-xl text-lg">‚öôÔ∏è</button>
                             <button onClick={() => setIsAddMonthOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md shadow-blue-100 italic">{selectedMonth}</button>
                        </div>
                    </header>

                    <main className="px-4 space-y-4 pt-2">
                        <PieChart data={currentBalances} />

                        <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 text-center">
                            <p className="text-gray-400 text-[10px] uppercase font-bold mb-1 tracking-widest">Thu nh·∫≠p th√°ng {selectedMonth}</p>
                            <div className="text-3xl font-black text-blue-600 mb-4 tracking-tighter">
                                {new Intl.NumberFormat('vi-VN').format(currentRecord.incomes.reduce((s, i) => s + i.amount, 0))} ‚Ç´
                            </div>
                            <button onClick={() => addTransaction('income')} className="w-full py-3.5 bg-gray-900 text-white rounded-2xl font-bold text-sm shadow-xl active:scale-95 transition-all">+ Th√™m thu nh·∫≠p</button>
                        </div>

                        <div className="grid grid-cols-1 gap-3 pb-10">
                            {currentBalances.map(jar => (
                                <div key={jar.id} className="bg-white p-4 rounded-[1.5rem] shadow-sm border border-gray-100 border-b-4 border-b-blue-100">
                                    <div className="flex justify-between items-start">
                                        <div className="flex gap-3">
                                            <div className="text-2xl">{jar.icon}</div>
                                            <div>
                                                <h4 className="font-bold text-sm text-gray-800">{jar.name}</h4>
                                                <p className="text-[10px] text-gray-400 font-bold">{jar.percentage}%</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-black text-gray-800 text-lg">{new Intl.NumberFormat('vi-VN').format(jar.amount)} ‚Ç´</div>
                                            <div className="text-[10px] text-red-400 font-bold">-{new Intl.NumberFormat('vi-VN').format(jar.spentThisMonth)} ‚Ç´</div>
                                        </div>
                                    </div>
                                    <button onClick={() => addTransaction('expense', jar.id)} className="mt-3 w-full py-2 bg-gray-50 text-gray-400 rounded-xl text-[10px] font-bold uppercase tracking-widest active:bg-blue-50 active:text-blue-500">Ghi chi ti√™u</button>
                                </div>
                            ))}
                        </div>
                    </main>

                    {isRatioEditOpen && (
                        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-md flex items-end sm:items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded-[2.5rem] w-full max-w-sm shadow-2xl animate-in slide-in-from-bottom duration-300">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-black text-gray-800 tracking-tighter">Thi·∫øt l·∫≠p t·ª∑ l·ªá</h3>
                                    <div className={`px-3 py-1 rounded-full text-sm font-black ${Object.values(tempRatios).reduce((s, v) => s + (parseInt(v) || 0), 0) === 100 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                        {Object.values(tempRatios).reduce((s, v) => s + (parseInt(v) || 0), 0)}%
                                    </div>
                                </div>
                                <div className="space-y-3 mb-8">
                                    {JAR_CONFIG.map(jar => (
                                        <div key={jar.id} className="flex items-center justify-between p-2">
                                            <span className="text-sm font-bold text-gray-500">{jar.name}</span>
                                            <div className="flex items-center gap-2">
                                                <input type="number" value={tempRatios[jar.id] || 0} onChange={e => setTempRatios({...tempRatios, [jar.id]: e.target.value})} className="w-16 p-2 text-center font-black text-blue-600 bg-gray-100 rounded-xl focus:ring-2 ring-blue-500 outline-none" />
                                                <span className="text-gray-300 font-bold">%</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setIsRatioEditOpen(false)} className="flex-1 py-4 text-gray-400 font-bold text-sm">H·ªßy b·ªè</button>
                                    <button onClick={saveRatios} className="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200">X√°c nh·∫≠n L∆∞u</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isAddMonthOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-6 z-50">
                            <div className="bg-white p-8 rounded-[2rem] w-full shadow-2xl">
                                <h3 className="font-black text-gray-800 mb-6">ƒê·ªïi th√°ng l√†m vi·ªác</h3>
                                <input type="month" className="w-full p-4 bg-gray-100 rounded-2xl mb-6 font-black text-blue-600 outline-none" onChange={(e) => {
                                    const m = e.target.value;
                                    if(m) {
                                        if(!history.find(h => h.month === m)) {
                                            setHistory(old => [...old, { month: m, incomes: [], expenses: [], ratios: currentRecord.ratios }].sort((a,b) => a.month.localeCompare(b.month)));
                                        }
                                        setSelectedMonth(m); setIsAddMonthOpen(false);
                                    }
                                }} />
                                <button onClick={() => setIsAddMonthOpen(false)} className="w-full py-2 text-gray-400 font-bold">ƒê√≥ng l·∫°i</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
