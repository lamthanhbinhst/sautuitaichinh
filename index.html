<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6 T√∫i T√†i Ch√≠nh - Full Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; margin: 0; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const JAR_CONFIG = [
            { id: 'NEC', name: 'Thi·∫øt y·∫øu', icon: 'üè†' },
            { id: 'FFA', name: 'T·ª± do t√†i ch√≠nh', icon: 'üìà' },
            { id: 'LTS', name: 'Ti·∫øt ki·ªám', icon: 'üí∞' },
            { id: 'EDU', name: 'Gi√°o d·ª•c', icon: 'üéì' },
            { id: 'PLAY', name: 'H∆∞·ªüng th·ª•', icon: 'üèñÔ∏è' },
            { id: 'GIVE', name: 'Cho ƒëi', icon: '‚ù§Ô∏è' },
        ];

        function App() {
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('financialData_v12');
                return saved ? JSON.parse(saved) : [{ 
                    month: new Date().toISOString().slice(0, 7), 
                    incomes: [], 
                    expenses: [],
                    ratios: { NEC: 55, FFA: 10, LTS: 10, EDU: 10, PLAY: 10, GIVE: 5 }
                }];
            });
            const [selectedMonth, setSelectedMonth] = useState(history[history.length - 1].month);

            useEffect(() => {
                localStorage.setItem('financialData_v12', JSON.stringify(history));
            }, [history]);

            const summaryDataByMonth = useMemo(() => {
                const res = {}; const cumul = {};
                const sortedHistory = [...history].sort((a, b) => a.month.localeCompare(b.month));
                sortedHistory.forEach(rec => {
                    const totalInc = rec.incomes.reduce((s, i) => s + i.amount, 0);
                    const ratios = rec.ratios || { NEC: 55, FFA: 10, LTS: 10, EDU: 10, PLAY: 10, GIVE: 5 };
                    const jarStats = JAR_CONFIG.map(j => {
                        const perc = ratios[j.id] || 0;
                        const added = (totalInc * perc) / 100;
                        const spent = rec.expenses.filter(e => e.jarId === j.id).reduce((s, e) => s + e.amount, 0);
                        const opening = cumul[j.id] || 0;
                        cumul[j.id] = opening + added - spent;
                        return { ...j, opening, added, spent, closing: cumul[j.id] };
                    });
                    res[rec.month] = jarStats;
                });
                return res;
            }, [history]);

            const exportFullCSV = () => {
                let csv = "\uFEFF"; // BOM h·ªó tr·ª£ ti·∫øng Vi·ªát
                
                // PH·∫¶N 1: TR√äN - B√ÅO C√ÅO ƒê·ªêI SO√ÅT
                csv += "PH·∫¶N 1: B√ÅO C√ÅO ƒê·ªêI SO√ÅT T·ªîNG H·ª¢P (S·ªê D∆Ø C√ÅC T√öI)\n";
                csv += "Th√°ng,T√™n T√∫i,S·ªë d∆∞ ƒë·∫ßu k·ª≥,S·ªë nh·∫≠p m·ªõi (+),S·ªë ƒë√£ chi (-),S·ªë d∆∞ cu·ªëi k·ª≥\n";
                
                const sortedMonths = Object.keys(summaryDataByMonth).sort();
                sortedMonths.forEach(m => {
                    summaryDataByMonth[m].forEach(jar => {
                        csv += `${m},${jar.name},${jar.opening},${jar.added},${jar.spent},${jar.closing}\n`;
                    });
                    // Th√™m d√≤ng t·ªïng th√°ng
                    const totalM = summaryDataByMonth[m];
                    csv += `${m},T·ªîNG C·ªòNG,${totalM.reduce((s,j)=>s+j.opening,0)},${totalM.reduce((s,j)=>s+j.added,0)},${totalM.reduce((s,j)=>s+j.spent,0)},${totalM.reduce((s,j)=>s+j.closing,0)}\n`;
                });

                // KHO·∫¢NG NGH·ªà GI·ªÆA 2 PH·∫¶N
                csv += "\n\n";

                // PH·∫¶N 2: D∆Ø·ªöI - NH·∫¨T K√ù CHI TI·∫æT
                csv += "PH·∫¶N 2: NH·∫¨T K√ù GIAO D·ªäCH CHI TI·∫æT (THU & CHI)\n";
                csv += "Th√°ng,Lo·∫°i,Ng√†y,N·ªôi dung,T√∫i s·ª≠ d·ª•ng,S·ªë ti·ªÅn\n";
                
                const sortedHistory = [...history].sort((a, b) => a.month.localeCompare(b.month));
                sortedHistory.forEach(record => {
                    record.incomes.forEach(i => {
                        csv += `${record.month},THU NH·∫¨P,${i.date},"${i.description}",-,${i.amount}\n`;
                    });
                    record.expenses.forEach(e => {
                        const jarName = JAR_CONFIG.find(j => j.id === e.jarId)?.name;
                        csv += `${record.month},CHI TI√äU,${e.date},"${e.description}",${jarName},${e.amount}\n`;
                    });
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Bao-cao-tai-chinh-Full-${selectedMonth}.csv`;
                link.click();
            };

            // ... (C√°c h√†m addTransaction, formatMoney gi·ªØ nguy√™n nh∆∞ b·∫£n c≈©)
            const addTransaction = (type, jarId = null) => {
                const amount = prompt("Nh·∫≠p s·ªë ti·ªÅn (ƒë):");
                const desc = prompt("M√¥ t·∫£ n·ªôi dung:");
                if (amount && !isNaN(amount) && desc) {
                    setHistory(old => old.map(r => r.month === selectedMonth ? {
                        ...r, [type === 'income' ? 'incomes' : 'expenses']: [...r[type === 'income' ? 'incomes' : 'expenses'], 
                        { id: Date.now().toString(), amount: parseInt(amount), description: desc, jarId, date: new Date().toLocaleDateString('vi-VN') }]
                    } : r));
                }
            };

            const formatMoney = (val) => new Intl.NumberFormat('vi-VN').format(val) + " ‚Ç´";
            const currentSummary = summaryDataByMonth[selectedMonth] || [];

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 pb-10">
                    <header className="p-4 bg-white shadow-sm flex justify-between items-center sticky top-0 z-40">
                        <h1 className="font-black text-xl italic text-gray-800">6 T√öI<span className="text-blue-600">.</span></h1>
                        <div className="flex gap-2">
                             <button onClick={exportFullCSV} className="w-10 h-10 flex items-center justify-center bg-green-100 text-green-700 rounded-xl" title="Xu·∫•t b√°o c√°o tr√™n-d∆∞·ªõi">üìä</button>
                             <button onClick={() => setSelectedMonth(prompt("Nh·∫≠p th√°ng (YYYY-MM):", selectedMonth))} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold">{selectedMonth}</button>
                        </div>
                    </header>

                    <main className="px-4 space-y-6 mt-4">
                        <div className="text-center bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                             <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Thu nh·∫≠p th√°ng</p>
                             <h2 className="text-3xl font-black text-blue-600">{formatMoney(history.find(h=>h.month===selectedMonth)?.incomes.reduce((s,i)=>s+i.amount,0) || 0)}</h2>
                             <button onClick={() => addTransaction('income')} className="mt-4 w-full py-3 bg-gray-900 text-white rounded-xl font-bold">+ TH√äM THU NH·∫¨P</button>
                        </div>

                        <div className="space-y-3">
                            {currentSummary.map(jar => (
                                <div key={jar.id} className="bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center shadow-sm">
                                    <div className="flex items-center gap-3">
                                        <span className="text-2xl">{jar.icon}</span>
                                        <div>
                                            <p className="font-bold text-sm text-gray-800">{jar.name}</p>
                                            <p className="text-[10px] text-red-400 font-bold italic">ƒê√£ chi: -{formatMoney(jar.spent)}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-black text-blue-700">{formatMoney(jar.closing)}</p>
                                        <button onClick={() => addTransaction('expense', jar.id)} className="text-[9px] font-black text-gray-400 uppercase tracking-tighter border-b border-gray-200 mt-1">Ghi Chi</button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* B·∫¢NG TR√äN APP V·∫™N HI·ªÇN TH·ªä ƒê·ªÇ B·∫†N THEO D√ïI NHANH */}
                        <div className="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm">
                            <div className="bg-blue-600 p-3 text-white text-[10px] font-bold uppercase text-center">B√°o c√°o ƒë·ªëi so√°t nhanh</div>
                            <table className="w-full text-[9px] text-left">
                                <thead className="bg-gray-50 text-gray-500 font-bold uppercase border-b">
                                    <tr><th className="p-2">T√∫i</th><th className="p-2 text-right">ƒê·∫ßu</th><th className="p-2 text-right">Chi</th><th className="p-2 text-right">Cu·ªëi</th></tr>
                                </thead>
                                <tbody>
                                    {currentSummary.map(j => (
                                        <tr key={j.id} className="border-b border-gray-50 italic">
                                            <td className="p-2 font-bold">{j.name}</td>
                                            <td className="p-2 text-right text-gray-400">{j.opening.toLocaleString()}</td>
                                            <td className="p-2 text-right text-red-400">-{j.spent.toLocaleString()}</td>
                                            <td className="p-2 text-right font-black text-blue-700">{j.closing.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </main>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
