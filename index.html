<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6 T√∫i T√†i Ch√≠nh</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; margin: 0; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const JAR_CONFIG = [
            { id: 'NEC', name: 'Thi·∫øt y·∫øu', color: 'bg-blue-500', icon: 'üè†' },
            { id: 'FFA', name: 'T·ª± do t√†i ch√≠nh', color: 'bg-green-500', icon: 'üìà' },
            { id: 'LTS', name: 'Ti·∫øt ki·ªám', color: 'bg-purple-500', icon: 'üí∞' },
            { id: 'EDU', name: 'Gi√°o d·ª•c', color: 'bg-orange-500', icon: 'üéì' },
            { id: 'PLAY', name: 'H∆∞·ªüng th·ª•', color: 'bg-red-500', icon: 'üèñÔ∏è' },
            { id: 'GIVE', name: 'Cho ƒëi', color: 'bg-pink-500', icon: '‚ù§Ô∏è' },
        ];

        const PieChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            useEffect(() => {
                if (chartInstance.current) chartInstance.current.destroy();
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(j => j.name),
                        datasets: [{
                            data: data.map(j => Math.max(0, j.amount)),
                            backgroundColor: ['#3b82f6', '#10b981', '#a855f7', '#f97316', '#ef4444', '#ec4899'],
                            borderWidth: 0
                        }]
                    },
                    options: { plugins: { legend: { display: false } }, cutout: '75%' }
                });
            }, [data]);
            return (
                <div className="relative w-40 h-40 mx-auto my-4">
                    <canvas ref={chartRef}></canvas>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">S·ªë d∆∞</span>
                        <span className="text-lg font-black text-gray-800">T·ªïng</span>
                    </div>
                </div>
            );
        };

        function App() {
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('financialData_v9');
                return saved ? JSON.parse(saved) : [{ 
                    month: new Date().toISOString().slice(0, 7), 
                    incomes: [], 
                    expenses: [],
                    ratios: { NEC: 55, FFA: 10, LTS: 10, EDU: 10, PLAY: 10, GIVE: 5 }
                }];
            });
            const [selectedMonth, setSelectedMonth] = useState(history[history.length - 1].month);
            const [isAddMonthOpen, setIsAddMonthOpen] = useState(false);
            const [isRatioEditOpen, setIsRatioEditOpen] = useState(false);
            const [tempRatios, setTempRatios] = useState({});

            useEffect(() => {
                localStorage.setItem('financialData_v9', JSON.stringify(history));
            }, [history]);

            const currentRecord = history.find(r => r.month === selectedMonth) || history[0];

            const summaryData = useMemo(() => {
                const res = {}; const cumul = {};
                const sortedHistory = [...history].sort((a, b) => a.month.localeCompare(b.month));
                sortedHistory.forEach(rec => {
                    const totalInc = rec.incomes.reduce((s, i) => s + i.amount, 0);
                    const ratios = rec.ratios || { NEC: 55, FFA: 10, LTS: 10, EDU: 10, PLAY: 10, GIVE: 5 };
                    const jarStats = JAR_CONFIG.map(j => {
                        const perc = ratios[j.id] || 0;
                        const added = (totalInc * perc) / 100;
                        const spent = rec.expenses.filter(e => e.jarId === j.id).reduce((s, e) => s + e.amount, 0);
                        const opening = cumul[j.id] || 0;
                        cumul[j.id] = opening + added - spent;
                        return { ...j, opening, added, spent, closing: cumul[j.id] };
                    });
                    res[rec.month] = jarStats;
                });
                return res;
            }, [history]);

            const currentSummary = summaryData[selectedMonth] || [];

            const exportAllToCSV = () => {
                let csvContent = "\uFEFF"; // BOM cho ti·∫øng Vi·ªát c√≥ d·∫•u
                csvContent += "Th√°ng,Lo·∫°i,Ng√†y,N·ªôi dung,T√∫i,S·ªë ti·ªÅn\n";
                
                // S·∫Øp x·∫øp l·ªãch s·ª≠ theo th·ªùi gian ƒë·ªÉ xu·∫•t file c√≥ th·ª© t·ª±
                const sortedHistory = [...history].sort((a, b) => a.month.localeCompare(b.month));

                sortedHistory.forEach(record => {
                    record.incomes.forEach(i => {
                        csvContent += `${record.month},THU,${i.date},"${i.description}",-,${i.amount}\n`;
                    });
                    record.expenses.forEach(e => {
                        const jarName = JAR_CONFIG.find(j => j.id === e.jarId)?.name;
                        csvContent += `${record.month},CHI,${e.date},"${e.description}",${jarName},${e.amount}\n`;
                    });
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                const today = new Date().toISOString().slice(0, 10);
                link.setAttribute("download", `Bao-cao-tong-hop-den-${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const addTransaction = (type, jarId = null) => {
                const amount = prompt("Nh·∫≠p s·ªë ti·ªÅn (ƒë):");
                const desc = prompt("M√¥ t·∫£ kho·∫£n n√†y:");
                if (amount && !isNaN(amount) && desc) {
                    setHistory(old => old.map(r => r.month === selectedMonth ? {
                        ...r, [type === 'income' ? 'incomes' : 'expenses']: [...r[type === 'income' ? 'incomes' : 'expenses'], 
                        { id: Date.now().toString(), amount: parseInt(amount), description: desc, jarId, date: new Date().toLocaleDateString('vi-VN') }]
                    } : r));
                }
            };

            const formatMoney = (val) => new Intl.NumberFormat('vi-VN').format(val) + " ‚Ç´";

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 pb-10">
                    <header className="p-4 bg-white shadow-sm flex justify-between items-center sticky top-0 z-40 border-b border-gray-100">
                        <h1 className="font-black text-xl text-gray-800 italic">6 T√öI<span className="text-blue-600">.</span></h1>
                        <div className="flex gap-2">
                             <button onClick={exportAllToCSV} className="w-10 h-10 flex items-center justify-center bg-green-100 text-green-700 rounded-xl" title="Xu·∫•t to√†n b·ªô d·ªØ li·ªáu">üìä</button>
                             <button onClick={() => { setTempRatios(currentRecord.ratios); setIsRatioEditOpen(true); }} className="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-xl">‚öôÔ∏è</button>
                             <button onClick={() => setIsAddMonthOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md">{selectedMonth}</button>
                        </div>
                    </header>

                    <main className="px-4 space-y-4 pt-2">
                        <PieChart data={currentSummary.map(s => ({...s, amount: s.closing}))} />
                        
                        <div className="bg-white p-6 rounded-[2rem] shadow-sm text-center border border-gray-100">
                            <p className="text-gray-400 text-[10px] uppercase font-bold tracking-widest mb-1">Thu nh·∫≠p th√°ng {selectedMonth}</p>
                            <div className="text-3xl font-black text-blue-600 mb-4 tracking-tighter">
                                {formatMoney(currentRecord.incomes.reduce((s, i) => s + i.amount, 0))}
                            </div>
                            <button onClick={() => addTransaction('income')} className="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold text-sm shadow-xl">+ TH√äM THU NH·∫¨P</button>
                        </div>

                        <div className="grid grid-cols-1 gap-3">
                            {currentSummary.map(jar => (
                                <div key={jar.id} className="bg-white p-4 rounded-[1.5rem] shadow-sm border border-gray-100">
                                    <div className="flex justify-between items-start">
                                        <div className="flex gap-3">
                                            <div className="text-2xl">{jar.icon}</div>
                                            <div>
                                                <h4 className="font-bold text-sm text-gray-800">{jar.name}</h4>
                                                <p className="text-[10px] text-gray-400 font-bold italic">{currentRecord.ratios?.[jar.id] || 0}% t·ªâ l·ªá</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-black text-gray-800 text-lg">{formatMoney(jar.closing)}</div>
                                            <div className="text-[10px] text-red-400 font-bold italic">Chi th√°ng n√†y: {formatMoney(jar.spent)}</div>
                                        </div>
                                    </div>
                                    <button onClick={() => addTransaction('expense', jar.id)} className="mt-3 w-full py-2 bg-gray-50 text-gray-400 rounded-xl text-[10px] font-bold uppercase tracking-widest">Ghi chi ti√™u t√∫i n√†y</button>
                                </div>
                            ))}
                        </div>

                        {/* NH·∫¨T K√ù */}
                        <div className="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden mt-6">
                            <div className="bg-gray-800 p-4 text-white flex justify-between items-center">
                                <h3 className="font-bold text-xs uppercase tracking-widest">Nh·∫≠t k√Ω {selectedMonth}</h3>
                                <button onClick={exportAllToCSV} className="text-[10px] bg-green-600 px-3 py-1.5 rounded-lg font-black shadow-sm">XU·∫§T TO√ÄN B·ªò (CSV)</button>
                            </div>
                            <div className="max-h-[400px] overflow-y-auto hide-scrollbar divide-y divide-gray-50">
                                {[...currentRecord.incomes, ...currentRecord.expenses].length === 0 ? (
                                    <p className="p-10 text-center text-gray-400 text-xs italic">Ch∆∞a c√≥ giao d·ªãch.</p>
                                ) : (
                                    <>
                                        {currentRecord.incomes.map(i => (
                                            <div key={i.id} className="p-4 flex justify-between items-center bg-green-50/20">
                                                <div className="flex gap-3 items-center">
                                                    <div className="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-[10px] font-bold">THU</div>
                                                    <div>
                                                        <div className="font-bold text-sm text-gray-800">{i.description}</div>
                                                        <div className="text-[10px] text-gray-400 italic">{i.date}</div>
                                                    </div>
                                                </div>
                                                <div className="font-black text-green-600">{formatMoney(i.amount)}</div>
                                            </div>
                                        ))}
                                        {currentRecord.expenses.map(e => (
                                            <div key={e.id} className="p-4 flex justify-between items-center">
                                                <div className="flex gap-3 items-center">
                                                    <div className="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center text-[10px] font-bold">CHI</div>
                                                    <div>
                                                        <div className="font-bold text-sm text-gray-800">{e.description}</div>
                                                        <div className="text-[10px] text-gray-400 italic">
                                                            {JAR_CONFIG.find(j=>j.id===e.jarId)?.name} ‚Ä¢ {e.date}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="font-black text-red-500">-{formatMoney(e.amount)}</div>
                                            </div>
                                        ))}
                                    </>
                                )}
                            </div>
                        </div>
                    </main>

                    {/* MODALS (GI·ªÆ NGUY√äN) */}
                    {isRatioEditOpen && (
                        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded-[2.5rem] w-full max-w-sm">
                                <h3 className="text-xl font-black mb-6">C√†i ƒë·∫∑t t·ª∑ l·ªá (%)</h3>
                                <div className="space-y-3 mb-6">
                                    {JAR_CONFIG.map(jar => (
                                        <div key={jar.id} className="flex items-center justify-between p-2 bg-gray-50 rounded-2xl">
                                            <span className="text-sm font-bold text-gray-600">{jar.name}</span>
                                            <input type="number" value={tempRatios[jar.id] || 0} onChange={e => setTempRatios({...tempRatios, [jar.id]: parseInt(e.target.value || 0)})} className="w-16 p-2 text-center font-black text-blue-600 bg-white border border-gray-100 rounded-xl" />
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => {
                                    const total = Object.values(tempRatios).reduce((s, v) => s + v, 0);
                                    if (total !== 100) return alert(`T·ªïng l√† ${total}%. Ph·∫£i ƒë√∫ng 100%!`);
                                    setHistory(old => old.map(r => r.month === selectedMonth ? { ...r, ratios: tempRatios } : r));
                                    setIsRatioEditOpen(false);
                                }} className="w-full py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg shadow-blue-200">X√°c nh·∫≠n L∆∞u</button>
                                <button onClick={() => setIsRatioEditOpen(false)} className="w-full py-2 text-gray-400 font-bold mt-2">ƒê√≥ng</button>
                            </div>
                        </div>
                    )}

                    {isAddMonthOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-6 z-50">
                            <div className="bg-white p-8 rounded-[2rem] w-full shadow-2xl text-center">
                                <h3 className="font-black mb-6">ƒê·ªïi th√°ng</h3>
                                <input type="month" className="w-full p-4 bg-gray-100 rounded-2xl mb-6 font-black text-blue-600 outline-none" onChange={(e) => {
                                    const m = e.target.value;
                                    if(m) {
                                        if(!history.find(h => h.month === m)) {
                                            setHistory(old => [...old, { month: m, incomes: [], expenses: [], ratios: currentRecord.ratios }].sort((a,b) => a.month.localeCompare(b.month)));
                                        }
                                        setSelectedMonth(m); setIsAddMonthOpen(false);
                                    }
                                }} />
                                <button onClick={() => setIsAddMonthOpen(false)} className="py-2 text-gray-400 font-bold uppercase text-xs">H·ªßy</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
